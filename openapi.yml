openapi: 3.0.0
info:
  title: Authentication API
  version: 0.0.1
  description: |
    **Waterfall Auth API** is a RESTful authentication service for user login,
    logout, token verification, refresh, and configuration/version endpoints.
    
    It uses JWT for access tokens and supports **secure, HttpOnly cookie-based**
    authentication.
servers:
  - url: http://localhost:5000
    description: Local development server
  - url: http://localhost:5001
    description: Staging development server
  - url: https://localhost:3000
    description: Proxied staging server

tags:
  - name: auth
    description: User authentication and token management endpoints.
  - name: admin
    description: System status and version endpoints.

paths:
  /api/auth/login:
    post:
      summary: User Login
      description: |
        Authenticates a user with email and password, issuing JWT access and refresh 
        tokens set as secure, HttpOnly cookies.
      tags:
        - auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful, tokens set as cookies.
          headers:
            Set-Cookie:
              $ref: '#/components/headers/AuthCookies'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DefaultResponse'
              example:
                message: Login successful
        '401':
          description: Invalid credentials (email or password).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DefaultResponse'
              example:
                message: Invalid email or password
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'

  /api/auth/verify:
    get:
      summary: Verify Access Token Validity
      description: Verifies the validity of the JWT access token from the cookies.
      tags:
        - auth
      parameters:
        - $ref: '#/components/parameters/AccessTokenCookie'
        # The refresh token is often not needed for simple verification, 
        # but kept here for consistency with your original design.
        - $ref: '#/components/parameters/RefreshTokenCookie'
      responses:
        '200':
          description: Token is valid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedToken'
  
  /api/auth/refresh:
    post:
      summary: Refresh Access Token
      description: Issues a new JWT access token using a valid refresh token. Typically rotates the refresh token too.
      tags:
        - auth
      parameters:
        - $ref: '#/components/parameters/RefreshTokenCookie'
      responses:
        '200':
          description: Tokens refreshed, new access and refresh tokens set as cookies.
          headers:
            Set-Cookie:
              $ref: '#/components/headers/AuthCookies'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DefaultResponse'
              example:
                message: Token refreshed
        '400':
          description: Missing refresh token.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DefaultResponse'
              example:
                message: Missing refresh token
        '401':
          description: Invalid or expired refresh token.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DefaultResponse'
              example:
                message: Invalid or expired refresh token

  /api/auth/logout:
    post:
      summary: User Logout and Token Revocation
      description: |
        Blacklists the access token, deletes the refresh token, and sends Set-Cookie 
        headers with expired dates to clear authentication cookies from the client.
      tags:
        - auth
      parameters:
        - $ref: '#/components/parameters/AccessTokenCookie'
        - $ref: '#/components/parameters/RefreshTokenCookie'
      responses:
        '200':
          description: Logout successful, cookies cleared.
          # In a real system, you'd send an "empty" Set-Cookie to clear the tokens.
          # Documenting the expected client response (cleared cookies) is usually sufficient.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DefaultResponse'
              example:
                message: "Logout successful"
        '400':
          description: Missing tokens.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DefaultResponse'
              example:
                message: "Missing tokens"
                
  /api/auth/health:
    get:
      summary: Service Health Check
      description: Returns information on the running service status.
      tags:
        - admin
      responses:
        '200':
          description: API is healthy.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/auth/version:
    get:
      summary: Get API Version
      description: Returns the current API version number.
      tags:
        - admin
      responses:
        '200':
          description: API version.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionResponse'

components:
  # ----------------------------------
  # REUSABLE PARAMETERS (Cookies)
  # ----------------------------------
  parameters:
    AccessTokenCookie:
      name: access_token
      in: cookie
      description: The short-lived JWT used for authorization.
      required: true
      schema:
        type: string
    RefreshTokenCookie:
      name: refresh_token
      in: cookie
      description: The long-lived JWT used to obtain a new access token.
      required: true
      schema:
        type: string

  # ----------------------------------
  # REUSABLE HEADERS
  # ----------------------------------
  headers:
    AuthCookies:
      description: |
        Sets the secure, HttpOnly `access_token` and `refresh_token` cookies.
        Note: The server typically sends two separate Set-Cookie headers, but OpenAPI 
        combines the description here for simplicity.
      schema:
        type: string
      example: >
        access_token=eyJhbGciOiJIUzI1NiI...; Max-Age=900; Path=/; HttpOnly; Secure,
        refresh_token=eyJhbGciOiJIUzI1NiI...; Max-Age=604800; Path=/; HttpOnly; Secure

  # ----------------------------------
  # REUSABLE SCHEMAS (Request/Response Bodies)
  # ----------------------------------
  schemas:
    DefaultResponse:
      type: object
      properties:
        message:
          type: string
          description: A simple status message.

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address.
        password:
          type: string
          format: password
          description: User's password.

    VerifyResponse:
      type: object
      properties:
        company_id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        user_id:
          type: string
          format: uuid
        valid:
          type: boolean

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        service:
          type: string
        message:
          type: string

    VersionResponse:
      type: object
      properties:
        version:
          type: string
          description: The current service version (e.g., '0.0.1').

  # ----------------------------------
  # REUSABLE RESPONSES
  # ----------------------------------
  responses:
    UnauthorizedToken:
      description: Token is missing, invalid, expired, or revoked.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/DefaultResponse'
          examples:
            missing:
              value:
                message: "Missing access token"
            expired:
              value:
                message: "Expired access token"

    UnsupportedMediaType:
      description: Did not attempt to load JSON data because the request Content-Type was not 'application/json'.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/DefaultResponse'
          example:
            message: "Unsupported Media Type. Request Content-Type must be 'application/json'."
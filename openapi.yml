openapi: 3.0.3
info:
  title: Auth API for Waterfall application
  version: "0.0.1"
  description: API for authentication, token management, configuration, version, health and documentation serving.

servers:
  - url: http://localhost:5000
    description: Local development server
  - url: http://localhost:5001
    description: Staging development server
  

paths:
  /login:
    post:
      summary: User login and token issuance
      description: |
        Authenticates a user and issues JWT access and refresh tokens as HttpOnly cookies.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful, tokens set as cookies
          headers:
            Set-Cookie:
              schema:
                type: string
              description: access_token / refresh_token HttpOnly cookies.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          description: Invalid email or password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'

  /logout:
    post:
      summary: User logout and token revocation
      description: |
        Blacklists the access token (if present), deletes the refresh token, and clears authentication cookies.
      responses:
        '200':
            description: Logout successful, cookies cleared
            headers:
              Set-Cookie:
                schema:
                  type: string
                description: Cleared cookies (expired).
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Missing tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'

  /refresh:
    post:
      summary: Refresh access token
      description: |
        Issues a new JWT access token using a valid refresh token. Rotates the refresh token (old one invalidated).
      responses:
        '200':
          description: Token refreshed, new access (and rotated refresh) token set as cookies
          headers:
            Set-Cookie:
              schema:
                type: string
              description: New access_token and refresh_token cookies.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Missing refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'

  /verify:
    get:
      summary: Verify access token
      description: Verifies the validity of the JWT access token from cookies.
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyResponse'
        '401':
          description: Token is missing, invalid, expired, or revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'

  /config:
    get:
      summary: Get application configuration
      description: Returns a subset of current application configuration (non-sensitive).
      responses:
        '200':
          description: Application configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'

  /version:
    get:
      summary: Get API version
      description: Returns the current API version.
      responses:
        '200':
          description: API version
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionResponse'

  /health:
    get:
      summary: Health check
      description: Returns a simple health status for the service.
      responses:
        '200':
          description: Service healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: access_token

  schemas:
    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      example:
        email: user@example.com
        password: secretPassword123

    MessageResponse:
      type: object
      properties:
        message:
            type: string
      example:
        message: Operation completed successfully

    VerifyResponse:
      type: object
      properties:
        user_id:
          type: string
          description: User identifier (UUID or string)
        company_id:
          type: string
          nullable: true
        email:
          type: string
          format: email
        valid:
          type: boolean
      example:
        user_id: 9f1c2a54-3b3d-451a-91ab-72f3f4d9b120
        company_id: null
        email: user@example.com
        valid: true

    ConfigResponse:
      type: object
      properties:
        FLASK_ENV:
          type: string
        DATABASE_URL:
          type: string
        LOG_LEVEL:
          type: string
        USER_SERVICE_URL:
          type: string
      example:
        FLASK_ENV: development
        DATABASE_URL: postgresql://auth_user:auth_pass@db:5432/auth_db
        LOG_LEVEL: INFO
        USER_SERVICE_URL: http://users_service:5000

    VersionResponse:
      type: object
      properties:
        version:
          type: string
      example:
        version: 0.0.1

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
      example:
        status: ok

    RefreshToken:
      type: object
      properties:
        id: { type: string }
        token: { type: string }
        user_id: { type: string }
        company_id: { type: string, nullable: true }
        created_at: { type: string, format: date-time }
        expires_at: { type: string, format: date-time }
        revoked: { type: boolean }
      example:
        id: 1b2c3d4e-5f6a-7b8c-9d00-1e2f3a4b5c6d
        token: 4f8c2b1d-9a78-4e13-bf12-77c0b98c12ef
        user_id: 9f1c2a54-3b3d-451a-91ab-72f3f4d9b120
        company_id: null
        created_at: 2025-01-12T10:15:30Z
        expires_at: 2025-01-19T10:15:30Z
        revoked: false

    TokenBlacklist:
      type: object
      properties:
        id: { type: string }
        jti: { type: string }
        user_id: { type: string }
        company_id: { type: string, nullable: true }
        created_at: { type: string, format: date-time }
        expires_at: { type: string, format: date-time }
      example:
        id: 7e6d5c4b-3a2f-1900-8c7b-6a5f4e3d2c1b
        jti: 12d4aa0b3c2145f0b7e51e1a9b524ac9
        user_id: 9f1c2a54-3b3d-451a-91ab-72f3f4d9b120
        company_id: null
        created_at: 2025-01-12T10:20:00Z
        expires_at: 2025-01-12T12:20:00Z

security:
  - cookieAuth: []